window.H=function(){function t(t,e,n){n=n||function(t){return t};var i=t.map(n);return e.filter(function(t){return i.indexOf(n(t))<0})}return{array:{diff:t}}}(),function(){function t(){}function e(t){return"[object Array]"===Object.prototype.toString.call(t)?[]:{}}var n=new t,i=new t,o=function(o,r){function a(t,n,i){var o=e(t);for(var r in t){var a=t[r]*(1-i)+n[r]*i;isNaN(a)||(o[r]=a)}return o}function s(t){if(f[r]<=t)return i;if(u[0][r]>=t)return n;for(var e=(t-u[r])/d,a=e*o.length-1|0,s=!1;!s;)o[a+1][r]<=t?a++:o[a][r]>t?a--:s=!0;var c=(t-o[a][r])/(o[a+1][r]-o[a][r]);return[a,a+1,c]}function c(e){var n=s(e);return n instanceof t?!1:a(o[n[0]],o[n[1]],n[2])}function l(t){var e=s(t);if(e===n)return!1;var i=o.slice(0,e[1]);return i.push(a(o[e[0]],o[e[1]],e[2])),i}var u=o[0],f=o[o.length-1],d=f[r]-u[r];this.by=c,this.until=l};window.M.Interpol=o}(),function(){function t(t,e){c[t]||(c[t]=[]),c[t].push(e)}function e(t,e){c[t]&&c[t].forEach(function(t){t(e)})}function n(t){t.forEach(function(t){t[l]=+new Date(t[l])}),this.earliest=t[0][l],this.latest=t[t.length-1][l],this.points=t,this.interpolate=new M.Interpol(t,l)}function i(t){var e=new n(t.pop());u=Math.min(u,e.earliest),f=Math.max(f,e.latest);var i=t.shift();d.push({id:h++,number:i,start:t.shift(),end:t.shift(),route:e})}function o(t){t.forEach(i),e("bulkpushed",{earliest:u,latest:f,time:u,speed:50,caffeinated:!1})}function r(t){var e=t[t.length-1],n=t[t.length-2]||e,i=e[0]-n[0],o=e[1]-n[1];return-Math.atan2(o,i)}function a(t){var e={underway:[],arrived:[]};return d.forEach(function(n){if(!(t<n.route.earliest)){var i=n.route.interpolate.until(t),o=r(i),a=t<n.route.latest?e.underway:e.arrived;a.push({object:n,heading:o,position:i[i.length-1],route:i})}}),e}var s={},c={},l=2,u=1/0,f=0,d=[],h=0,v=function(){var t={is:function(t,e){return t===e},matches:function(t,e){return t.match(e)}};return function(e){"string"==typeof e&&(e=[["number","is",e]]);var n=e.length;return d.filter(function(i){for(var o=0;n>o;o++){var r=e[o];if(val=i[r[0]],!t[r[1]](val,r[2]))return!1}return!0})}}();s.push=i,s.pushBulk=o,s.until=a,s.raw=d,s.on=t,s.find=v,M.flights=s}(),M.rumble=function(){function t(t,n){var i="translate("+t+"px, "+n+"px)";e.css("transform",i).css("-ms-transform",i).css("transform",i)}var e=$(document.body),n=20,i=8;return function(){var e=setInterval(function(){t(Math.round(5-10*Math.random()),Math.round(5-10*Math.random()))},n);setTimeout(function(){clearInterval(e),t(0,0)},n*i)}}(),window.M.clock=function(){function t(){if(S===b)throw new D.notInitialized;return!0}function e(t){if(P[t])for(var e=0,n=P[t].length;n>e;e++)P[t][e](i())}function n(){return(new Date).valueOf()}function i(){var t=S+E*L.speed*o();return a(t)}function o(){return n()-C}function r(){S=i(),C=n()}function a(t){return Math.max(L.earliest,Math.min(L.latest,t))}function s(){var t=i();(t!==T||L.caffeinated)&&e("tick"),T=t,window.requestAnimationFrame(s)}function c(t){$.extend(L,t),v(L.time.valueOf()),window.requestAnimationFrame(s),e("init")}function l(n){return t(),n===b?L.speed:(r(),L.speed=n,void e("speedchange"))}function u(){t(),E||(r(),E=1,e("play"))}function f(){t(),E&&(r(),E=0,e("pause"))}function d(){return!E}function h(){return E}function v(t){r(),S=a(t.valueOf())}function m(){return t(),i()}function g(){L.caffeinated=!0}function p(){L.caffeinated=!1}function w(){return new Date(i())}function y(t){return t===b?m():void v(t)}function M(){return L.earliest}function x(){return L.latest}function k(t,e){P[t]||(P[t]=[]),P[t].push(e)}var b,S,C,T,E=1,P={},L={time:new Date,speed:1,earliest:0,latest:1/0,caffeinated:!1},D={notInitialized:function(){this.name="NotInitializedError",this.message="Clock is not initialized. Call `Clock.init([options])` first.",this.toString=function(){return this.message}}};return{init:c,time:y,get:m,date:w,caffeinate:g,decaffeinate:p,speed:l,earliest:M,latest:x,start:u,pause:f,paused:d,running:h,set:v,on:k,error:D}}(),M.timeline=function(){function t(t){return t*o}function e(e,n){n=n||9,e.font=t(n)+"pt "+$(document.body).css("font-family")}function n(){var t,e,n;t=arguments[0],n=arguments[arguments.length-1],e=arguments.length>2?arguments[1]:M.clock.earliest();var i,o=t-e;return{timeline:function(){i={x:o*r}}}[n](),i}function i(i,o){function s(t){return t+.5}o||(o=document.createElement("canvas")),i=M.clock.earliest();var c=$(o),l=(M.clock.latest()-i)*r,u=c.height();c.attr("width",t(l)),c.attr("height",t(u)),c.css({width:l+"px",height:u+"px"});var f=o.getContext("2d");f.clearRect(0,0,t(l),t(u)),f.strokeStyle=a.strokeStyle,f.fillStyle=a.fillStyle,f.lineWidth=a.lineWidth,e(f,9),f.textAlign="center",f.textBaseline="top";for(var d=moment.tz(M.clock.earliest(),M.settings.timezone).startOf("hour"),h=moment.tz(M.clock.latest(),M.settings.timezone);d.isBefore(h);){var v=n(d,i,"timeline").x;if(v>=0||l>=v){var m=u,g=d.hour();f.lineWidth=0===g?3:12===g?2:1,f.beginPath(),f.moveTo(t(s(v)),t(u)),f.lineTo(t(s(v)),t(u-m)),f.stroke(),g%6===0&&f.fillText(g,t(s(v)),t(2)),d.add(1,"hour")}}return o}var o=window.devicePixelRatio,r=4/6e5,a={strokeStyle:"#ccc",fillStyle:"#000",lineWidth:t(1/window.devicePixelRatio)};return{timeline:i,timeScale:r}}(),M.timeHUD=function(){function t(t,e){t=""+t;for(var n=t.length;e>n;n++)t="0"+t;return t}function e(e){e=moment.tz(e,M.settings.timezone),o.text(t(e.date(),2)),r.text(l[e.month()]),a.text(e.year()),s.text(t(e.hours(),2)),c.text(t(e.minutes(),2))}function n(t){i=$(t),o=i.find(".js-day"),r=i.find(".js-month"),a=i.find(".js-year"),s=i.find(".js-hour"),c=i.find(".js-minute"),M.clock.on("tick",e)}var i,o,r,a,s,c,l="Jan Feb Mär Apr Mai Jun Jul Aug Sep Okt Nov Dez".split(" ");return{init:n}}(),$(function(){function t(t){i||e(),+t||(t=M.clock.time());var n=t-M.clock.earliest();$("#timeline-graph").css("marginLeft",-n*M.timeline.timeScale)}function e(t){+t||(t=M.clock.time()),M.timeline.timeline(t,document.getElementById("timeline-graph")),i=!0}var n=1/M.timeline.timeScale,i=!1;M.clock.on("tick",t),$(window).on("resize",t);var o,r,a,s,c=($(".timeline-chart"),$(document)),l=!1;c.on("movestart",".timeline-chart",function(){l=!0,$(document.body).addClass("dragging"),o=M.clock.time(),s=M.clock.running(),M.clock.pause(),u.stop()}),c.on("move",function(t){if(l){t.preventDefault();var e=-t.distX*n;r=o+e,a=Date.now(),M.clock.set(r)}}),c.on("moveend",function(t){if(l){l=!1,$(document.body).removeClass("dragging");var e=-t.distX*n,i=o+e,c=Date.now(),f=(i-r)/(c-a);M.clock.set(i),u.start(f),s&&M.clock.start()}});var u=function(){return{start:function(){},stop:function(){}}}(),f={32:function(t){t.preventDefault(),$("#button-play-pause").addClass("active")},37:function(t){t.preventDefault,M.clock.set(M.clock.time()-(t.shiftKey?36e5:6e4))},39:function(t){t.preventDefault,M.clock.set(M.clock.time()+(t.shiftKey?36e5:6e4))}},d={32:function(){$("#button-play-pause").removeClass("active").click()}};$(document).keydown(function(t){try{f[t.keyCode](t)}catch(e){}}),$(document).keyup(function(t){try{d[t.keyCode](t)}catch(e){}}),$("#button-play-pause").click(function(){var t=$(this);M.clock.paused()?(M.clock.start(),t.addClass("playing").removeClass("paused")):(M.clock.pause(),t.addClass("paused").removeClass("playing"))}),$(".slider-simulation-speed").on("mousemove change",function(){var t=Math.pow(.5*parseInt($(this).val(),10),3);$(document.body).toggleClass("backwards",0>t);try{M.clock.speed(t)}catch(e){}}),M.clock.on("init",function(){$(".slider-simulation-speed").trigger("mousemove")}),M.timeHUD.init(".timeline-time-hud")}),window.M.Overlay=function(t,e){function n(){this.setBounds(e.bounds),this.setDimensions(e.width,e.height)}function i(t){return t*window.devicePixelRatio}function o(t){return t[0]/180}function r(t){return Math.log(Math.tan(Math.PI/4+t[1]*(Math.PI/180)/2))/Math.PI}function a(t){return f.width*(t-v.w)/(v.e-v.w)}function s(t){return f.height*(t-v.n)/(v.s-v.n)}function c(t){return a(t[0])}function l(t){return s(t[1])}function u(t,e){function n(t){void 0!==t&&(s.attr("width",i(t)),s.css("width",t+"px"))}function o(t){void 0!==t&&(s.attr("height",i(t)),s.css("height",t+"px"))}function r(){p&&p.forEach(function(t){v[t.property]=t.value})}function a(t,e){return y[t]?void y[t].forEach(function(t){t.call(w,e)}):!1}var s=$("<canvas>"),u=s[0],v=u.getContext("2d");s.attr("id","map-layer-"+t),h.append(s),e=e||{};var p,w=this;v.fillStyle="#000",v.strokeStyle="#000",this._updateDimensions=function(){o(f.height),n(f.width)},this.redraw=function(){this.clear(),r(),a("redraw",w)};var y=(function(){function t(t,e){void 0===e&&(e=!0);for(var i in t)e&&(n[i]=t[i]),v[i]=t[i]}function e(){t(n,!1),n={}}var n={};return{set:t,restore:e}}(),{});this.on=function(t,e){y[t]||(y[t]=[]),y[t].push(e)},this.always=function(t){this.on("redraw",t),t.call(w,w)},this.setBaseStyles=function(t){p=[];for(var e in t)p.push({property:e,value:t[e]});r()},this.projectGeoJSON=function(t){m[t.type](t)},this.drawGeoJSON=function(t,e){t.features.sort(function(t,e){return(t.properties.layer||0)-(e.properties.layer||0)}),t.features.forEach(function(t){v.beginPath(),g[t.geometry.type].call(v,t.geometry.coordinates),e&&e.call(v,v)})},this.drawLine=function(t){v.beginPath(),this.moveTo(t[0]),t.slice(1).forEach(this.lineTo),v.stroke()},this.drawFadingLine=function(t,e,n,o){var r=t[t.length-1],a=i(c(r)),s=i(l(r)),u=v.createRadialGradient(a,s,0,a,s,i(o));u.addColorStop(0,e),u.addColorStop(1,n),v.strokeStyle=u,v.beginPath(),this.moveTo(t[0]),t.slice(1).forEach(this.lineTo),v.stroke()},this.moveTo=function(t){v.moveTo(i(c(t)),i(l(t)))},this.lineTo=function(t){v.lineTo(i(c(t)),i(l(t)))},this.drawCircle=function(t,e){v.beginPath(),v.arc(i(c(t)),i(l(t)),i(e),0,2*Math.PI)},this.drawSquarePoint=function(t,e){v.fillRect(i(c(t)-e/2),i(l(t)-e/2),e,e)},this.drawMarker=function(t,e,n){n&&this.rotateTranslateDo(e,n,function(){try{v.drawImage(t,i(t.width/-2),i(t.height/-2),i(t.width),i(t.height))}catch(e){if("NS_ERROR_NOT_AVAILABLE"!==e.name)throw e}})},this.drawImage=function(t,e){e={n:l(e.nw),w:c(e.nw),s:l(e.se),e:c(e.se)};i(e.e-e.w),i(e.s-e.n);v.drawImage(t,i(e.w),i(e.n),i(e.e-e.w),i(e.s-e.n))},this.fillText=function(t,e,n,o){v.fillText(t,i(c(e)+n),i(l(e)+o))},this.strokeFillText=function(t,e,n,o){v.strokeText(t,i(c(e)+n),i(l(e)+o)),v.fillText(t,i(c(e)+n),i(l(e)+o))},this.rotateTranslateDo=function(t,e,n){v.save(),v.translate(i(c(t)),i(l(t))),e&&v.rotate(e),n.call(this,this),v.restore()},this.clear=function(){M=[],v.clearRect(0,0,u.width,u.height)},this.delete=function(){s.remove(),delete d.layers[t]};var M=[];if(e.interactive){this.drawHotspot=function(t,e,n){M.push({x:c(t),y:l(t),r:e,data:n})};var x=null;s.on("mousemove mouseenter mouseleave",function(t){var e=t.originalEvent.layerX,n=t.originalEvent.layerY,i=M.filter(function(t){var i=t.x-e,o=t.y-n,r=Math.sqrt(i*i+o*o);return r>t.r?!1:(t.dist=r,!0)});if(i.length>0){var o=i.sort(function(t,e){return t.dist-e.dist})[0].data;s.css("cursor","pointer"),a("mousemove",o),x!==o&&(a("mouseleave",x),a("mouseenter",o)),x=o}else x&&a("mouseleave",x),s.css("cursor","default"),x=null})}this.ctx=v,this._updateDimensions()}var f={},d=this,h=$(t);this.layers={};var v={},m={FeatureCollection:function(t){t.features.forEach(m.Feature)},Feature:function(t){m[t.geometry.type](t.geometry.coordinates)},MultiPolygon:function(t){t.forEach(m.Polygon)},Polygon:function(t){t.forEach(m.LineString)},MultiLineString:function(t){t.forEach(m.LineString)},LineString:function(t){t.forEach(m.Point)},MultiPoint:function(t){t.forEach(m.Point)},Point:function(t){t[0]=o(t),t[1]=r(t)}},g={MultiPolygon:function(t){t.forEach(g.Polygon,this)},Polygon:function(t){t.forEach(g.LineString,this)},MultiLineString:function(t){t.forEach(g.LineString,this)},LineString:function(t){this.moveTo(i(c(t[0])),i(l(t[0]))),t.slice(1).forEach(function(t){this.lineTo(i(c(t)),i(l(t)))},this)},MultiPoint:function(){console.warn("MultiPoint geometry not implemented in renderGeoJSON")},Point:function(t){this.fillRect(i(c(t)-5),i(l(t)-5),i(10),i(10))}};this.addLayer=function(t,e){var n=new u(t,e);return d.layers[t]=n,n},this.setBounds=function(t){v=t},this.setDimensions=function(t,e){f.width=t,f.height=e;for(var n in d.layers)d.layers[n]._updateDimensions()},this.redraw=function(){for(var t in d.layers)d.layers[t].redraw()},n.call(this)},$(function(){var t=$("#embed textarea");t.val(t.val().replace(/src=".*?"/,'src="'+window.location+'"'));var e=$(".modal-overlay"),n={embed:function(){$(this).find("textarea").select()}};$(".modal").each(function(t,i){var o=$(i);$("[href=#"+i.id+"]").each(function(t,r){$(r).click(function(t){t.preventDefault(),o.addClass("visible").removeClass("hidden"),e.addClass("visible").removeClass("hidden"),n[i.id]&&n[i.id].call(i,t)})})}),$("body").on("movestart",".modal",function(t){t.preventDefault()}),e.click(function(){e.addClass("hidden").removeClass("visible"),$(".modal").addClass("hidden").removeClass("visible")});var i=$("#flightlist tbody");M.flights.on("bulkpushed",function(){M.flights.raw.forEach(function(t){(t.start||t.end||t.number)&&($tr=$("<tr>"),$number=$("<td>").addClass("number").text(t.number),$start=$("<td>").addClass("start").text(t.start),$end=$("<td>").addClass("end").text(t.end),$tr.append($number,$start,$end),i.append($tr),$(".js-download-tsv").attr("href","data/"+M.params.date+".tsv"))})}),$(".credits").on("touchstart",function(t){return t.target===this?!1:void 0})}),M.params=function(){var t,e=window.location.search.substring(1);if(!e)return{};var n={};return e=e.split("&"),e.forEach(function(e){var i=e.split("="),o=i[1]===t?!0:i[1];n[i[0]]=o}),n}(),$(function(){"use strict";function t(t){return t*window.devicePixelRatio}function e(){var t=d.locationPoint(new MM.Location(0,0)),e=d.locationPoint(new MM.Location(-85.05113,180));v={origin:t,sw:e,delta:{x:e.x-t.x,y:e.y-t.y}}}function n(){var t=0,e=i([-t,-t]),n=i([c.width()+t,c.height()+t]),o={n:e[1],e:n[0],s:n[1],w:e[0]};m.setBounds(o)}function i(t){return[(t[0]-v.origin.x)/v.delta.x,(t[1]-v.origin.y)/-v.delta.y]}function o(e){var n=e.heading,i="right",o=-20;n>s?(n-=Math.PI,i="left",o*=-1):-s>n&&(n+=Math.PI,i="left",o*=-1);var r=8,a=e.object.number,c=e.object.start+"—"+e.object.end;"—"===c?(c="",r=0):""===a&&(r=0),""===a&&""===c&&(c="(keine Daten)"),k.rotateTranslateDo(e.position,n,function(){this.ctx.textAlign=i,this.ctx.strokeText(c,t(o),t(r)),this.ctx.fillText(c,t(o),t(r)),this.ctx.font="bold "+this.ctx.font,this.ctx.strokeText(a,t(o),t(-r)),this.ctx.fillText(a,t(o),t(-r))})}function r(t){x.drawMarker(T,t.position,t.heading)}function a(e,n){n=n||x,n.ctx.save(),n.ctx.globalCompositeOperation="darker",n.ctx.globalAlpha=1,n.ctx.strokeStyle="rgba(255,0,0,.5)",n.ctx.lineWidth=t(4),n.drawCircle(e.position,20),n.ctx.stroke(),n.ctx.restore()}var s=Math.PI/2,c=$(window);FastClick.attach(document.body),$('input[type="range"]').rangeslider({polyfill:!1});var l="sans-serif",u="//tiles.odcdn.de/mh17/{Z}/{X}/{Y}.png",f=new MM.TemplatedLayer(u),d=new MM.Map("map-container",f,null,[]),h={nw:new MM.Location(51,41),se:new MM.Location(46,35)};d.setExtent([h.nw,h.se],!0),d.coordLimits=[d.locationCoordinate(h.nw).zoomTo(5),d.locationCoordinate(h.se).zoomTo(12)],f.tileLimits=d.coordLimits,c.resize(function(){d.setExtent([h.nw,h.se],!0)});var v,m=new M.Overlay($("#map-container"),{bounds:{n:51,s:46,w:35,e:41},width:c.width(),height:c.height()});d.addCallback("drawn",e),d.addCallback("drawn",n),d.addCallback("drawn",m.redraw),d.addCallback("drawn",function(){E(null,!0)});var g=m.addLayer("nofly");g.setBaseStyles({fillStyle:"rgba(0,0,0,.2)",font:t(14)+"px "+l,textAlign:"center",textBaseline:"middle"}),$.getJSON("data/no-fly.geojson",function(t){g.projectGeoJSON(t),g.always(function(){g.ctx.save(),g.drawGeoJSON(t,function(t){t.fill()}),g.ctx.fillStyle="rgba(0,0,0,.5)";var e="2014-07-24"===M.params.date?"":"unterhalb 9750 m";g.fillText(e,[.2138,.31],0,8),g.ctx.font="bold "+g.ctx.font,g.fillText("Flugverbot",[.2138,.31],0,-8),g.ctx.restore()})});var p=.04,w=.5,y=m.addLayer("arrived"),x=m.addLayer("underway"),k=m.addLayer("label"),b=m.addLayer("hotspots",{interactive:!0});x.setBaseStyles({lineWidth:t(5),lineJoin:"round"}),y.setBaseStyles({lineWidth:t(5),globalAlpha:p,lineJoin:"round"}),k.setBaseStyles({font:t(14)+"px "+l,lineWidth:t(3),textAlign:"right",textBaseline:"middle",lineJoin:"round",strokeStyle:"#fff"}),M.params.date=M.params.date||"2014-07-17";var S=M.params.date;$(".js-date-"+S).addClass("selected"),$.getJSON("data/"+S+".json",M.flights.pushBulk),M.flights.on("bulkpushed",M.clock.init),M.flights.on("bulkpushed",function(){if(M.params.t){var t=M.params.t;isNaN(+t)&&(t=new Date(t)),M.clock.time(+t)}}),M.flights.on("bulkpushed",function(){var e=M.flights.find("Malaysia Airlines 17")[0];e.notify=!0;var n=e.route.points[e.route.points.length-1];g.always(function(){this.rotateTranslateDo(n,0,function(){this.ctx.globalAlpha=.5,this.ctx.lineWidth=t(5),this.ctx.beginPath(),this.ctx.moveTo(t(-8),t(-8)),this.ctx.lineTo(t(8),t(8)),this.ctx.moveTo(t(-8),t(8)),this.ctx.lineTo(t(8),t(-8)),this.ctx.stroke(),this.ctx.fillStyle="#000",this.ctx.textAlign="left",this.ctx.fillText("Absturz von MH17",t(15),0)})})}),b.on("mouseenter",function(t){C=t,M.clock.paused()&&o(t)}),b.on("mouseleave",function(){C=null,M.clock.paused()&&E()});var C,T=$('<img src="images/plane.svg">')[0],E=function(){var t=[],e=!0;return function(n,i){function s(t){var e=Math.min(1,(t.object.route.latest-n)/3e5),i=p+e*(w-p);i=Math.max(i,p),x.ctx.save(),C&&t.object===C.object&&o(t),t.object.notify&&a(t),x.ctx.globalAlpha=1;var s="rgba(0,0,0,"+i+")",c="rgba(0,0,0,"+p+")";x.drawFadingLine(t.route,s,c,150),x.ctx.globalAlpha=i,r(t),x.ctx.restore(),b.drawHotspot(t.position,20,t)}function c(t){if(t.object.notify){var n=t.object.route.points[t.object.route.points.length-1];a({position:n},y),e&&M.rumble()}y.drawLine(t.route)}n=M.clock.time();var l=M.flights.until(n);x.clear(),b.clear(),k.clear(),l.underway.forEach(s),l.arrived.length>t.length&&!i?(e=!0,H.array.diff(t,l.arrived,function(t){return t.object.id}).forEach(c)):(l.arrived.length<t.length||i)&&(y.clear(),e=!1,l.arrived.forEach(c)),t=l.arrived}}();M.clock.on("tick",E);var P=function(){m.setDimensions(c.width(),c.height())};c.resize(P)});